name: Publish unison-common

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., 0.1.0)'
        required: true
        type: string
      repository_url:
        description: 'Private PyPI repository URL'
        required: true
        type: string
      skip_tests:
        description: 'Skip running tests'
        required: false
        type: boolean
        default: false
      skip_update:
        description: 'Skip updating service dependencies'
        required: false
        type: boolean
        default: false
      dry_run:
        description: "Build and check but don't publish"
        required: false
        type: boolean
        default: false
  push:
    tags:
      - 'unison-common-v*'

env:
  PYTHON_VERSION: '3.12'

jobs:
  test:
    name: Test Package
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine wheel
        pip install -e .[test]
    
    - name: Run tests
      run: |
        python -m pytest tests/ -v
    
    - name: Check package
      run: |
        python -m build
        python -m twine check dist/*

  publish:
    name: Publish Package
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine wheel
        pip install -e .
    
    - name: Extract version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${{ github.ref_name }}"
          VERSION=${VERSION#unison-common-v}  # Remove prefix
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ Publishing version: $VERSION"
    
    - name: Update version in pyproject.toml
      run: |
        sed -i "s/version = \".*\"/version = \"${{ steps.version.outputs.version }}\"/" pyproject.toml
        echo "âœ… Updated version to ${{ steps.version.outputs.version }}"
    
    - name: Build package
      run: |
        python -m build
    
    - name: Check package
      run: |
        python -m twine check dist/*
    
    - name: Determine repository URL
      id: repo
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          REPO_URL="${{ github.event.inputs.repository_url }}"
        else
          REPO_URL="${{ secrets.PRIVATE_PYPI_URL || 'https://pypi.org/simple/' }}"
        fi
        echo "url=$REPO_URL" >> $GITHUB_OUTPUT
        echo "ðŸ”— Repository URL: $REPO_URL"
    
    - name: Publish to private PyPI
      if: ${{ github.event.inputs.dry_run != 'true' && !startsWith(github.ref, 'refs/tags/unison-common-v') }}
      env:
        TWINE_USERNAME: ${{ secrets.PRIVATE_PYPI_USERNAME || '__token__' }}
        TWINE_PASSWORD: ${{ secrets.PRIVATE_PYPI_PASSWORD }}
      run: |
        python -m twine upload \
          --repository-url ${{ steps.repo.outputs.url }} \
          --username $TWINE_USERNAME \
          --password $TWINE_PASSWORD \
          dist/*
    
    - name: Dry run - check only
      if: ${{ github.event.inputs.dry_run == 'true' || startsWith(github.ref, 'refs/tags/unison-common-v') }}
      run: |
        echo "ðŸ” Dry run mode - package built and checked but not published"
        ls -la dist/
    
    - name: Update service dependencies
      if: ${{ github.event.inputs.skip_update != 'true' && github.event.inputs.dry_run != 'true' }}
      run: |
        echo "ðŸ”„ Updating service dependencies..."
        VERSION="${{ steps.version.outputs.version }}"
        
        # Update unison-orchestrator
        if [ -d "../unison-orchestrator" ]; then
          sed -i "s/unison-common==.*/unison-common==$VERSION/" ../unison-orchestrator/requirements.txt
          echo "âœ… Updated unison-orchestrator"
        fi
        
        # Update other services
        for service in unison-context-graph unison-consent unison-policy; do
          if [ -d "../$service" ]; then
            if [ -f "../$service/requirements.txt" ]; then
              sed -i "s/unison-common==.*/unison-common==$VERSION/" ../$service/requirements.txt
              echo "âœ… Updated $service"
            fi
          fi
        done
    
    - name: Commit and push updates
      if: ${{ github.event.inputs.skip_update != 'true' && github.event.inputs.dry_run != 'true' }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add updated requirements files
        git add ../unison-orchestrator/requirements.txt || true
        git add ../unison-context-graph/requirements.txt || true
        git add ../unison-consent/requirements.txt || true
        git add ../unison-policy/requirements.txt || true
        
        # Commit if there are changes
        if git diff --staged --quiet; then
          echo "ðŸ“‹ No dependency updates to commit"
        else
          git commit -m "chore: update unison-common to v${{ steps.version.outputs.version }}"
          git push
          echo "âœ… Committed and pushed dependency updates"
        fi
    
    - name: Create release tag
      if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true' }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "unison-common-v${{ steps.version.outputs.version }}" \
          -m "Release unison-common v${{ steps.version.outputs.version }}"
        git push origin "unison-common-v${{ steps.version.outputs.version }}"
        echo "ðŸ·ï¸  Created and pushed tag unison-common-v${{ steps.version.outputs.version }}"
    
    - name: Summary
      run: |
        echo "## ðŸŽ‰ Publish Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ steps.repo.outputs.url }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ github.event.inputs.dry_run == 'true' && 'Dry Run' || 'Published' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Package Contents:" >> $GITHUB_STEP_SUMMARY
        ls -la dist/ >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”„ Next Steps:" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          echo "- Run workflow without \`--dry-run\` to actually publish" >> $GITHUB_STEP_SUMMARY
        else
          echo "- Services updated to use new version" >> $GITHUB_STEP_SUMMARY
          echo "- Test services with new dependency" >> $GITHUB_STEP_SUMMARY
          echo "- Create GitHub release if desired" >> $GITHUB_STEP_SUMMARY
        fi

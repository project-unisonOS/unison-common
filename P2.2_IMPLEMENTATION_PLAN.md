# P2.2: unison-common Release + Contract Tests

**Date**: November 7, 2025  
**Status**: Archived (work completed; see README and tests)  
**Goal**: Package unison-common for distribution and implement contract testing

---

## üìã Overview

Transform unison-common from editable install (`-e ../unison-common`) to a proper packaged library with contract tests to ensure API compatibility across services.

---

## üéØ Objectives

1. **Package unison-common v0.1.0** for distribution
2. **Generate JSON schemas** from Pydantic models
3. **Create contract test suite** to validate message schemas
4. **Set up package distribution** (local/private PyPI)
5. **Update all services** to use packaged version
6. **Add CI/CD integration** for automated contract testing

---

## üìä Current State Audit

### unison-common Structure

```
unison-common/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ unison_common/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ auth.py (18KB)
‚îÇ       ‚îú‚îÄ‚îÄ auth_rs256.py (8KB)
‚îÇ       ‚îú‚îÄ‚îÄ consent.py (7KB)
‚îÇ       ‚îú‚îÄ‚îÄ consent_rs256.py (10KB)
‚îÇ       ‚îú‚îÄ‚îÄ envelope.py (16KB) - EventEnvelope model
‚îÇ       ‚îú‚îÄ‚îÄ http_client.py (5KB)
‚îÇ       ‚îú‚îÄ‚îÄ http_client_tracing.py (7KB)
‚îÇ       ‚îú‚îÄ‚îÄ idempotency.py (12KB)
‚îÇ       ‚îú‚îÄ‚îÄ idempotency_middleware.py (9KB)
‚îÇ       ‚îú‚îÄ‚îÄ logging.py (351B)
‚îÇ       ‚îú‚îÄ‚îÄ monitoring.py (12KB)
‚îÇ       ‚îú‚îÄ‚îÄ performance.py (12KB)
‚îÇ       ‚îú‚îÄ‚îÄ replay_endpoints.py (11KB)
‚îÇ       ‚îú‚îÄ‚îÄ replay_store.py (20KB)
‚îÇ       ‚îú‚îÄ‚îÄ schema_validation.py (13KB)
‚îÇ       ‚îú‚îÄ‚îÄ tracing.py (14KB)
‚îÇ       ‚îî‚îÄ‚îÄ tracing_middleware.py (6KB)
‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îî‚îÄ‚îÄ event-envelope.json (4KB)
‚îú‚îÄ‚îÄ tests/ (17 test files)
‚îú‚îÄ‚îÄ pyproject.toml
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ PUBLISHING.md
‚îî‚îÄ‚îÄ generate_schema_docs.py
```

### Current Package Configuration

**pyproject.toml**:
- Version: 0.1.0
- Python: >=3.12
- Dependencies: FastAPI, httpx, redis, jsonschema, OpenTelemetry, etc.

### Services Using unison-common

All services currently use editable install:
```bash
pip install -e ../unison-common
```

**Services**:
1. unison-orchestrator
2. unison-storage
3. unison-policy
4. unison-auth
5. unison-consent
6. unison-context
7. unison-inference
8. unison-intent-graph
9. unison-context-graph
10. unison-experience-renderer
11. unison-agent-vdi
12. unison-io-core
13. unison-io-speech
14. unison-io-vision

---

## üîß Implementation Tasks

### Phase 1: Schema Generation

**Goal**: Generate JSON schemas from all Pydantic models

**Tasks**:
- [ ] Audit all Pydantic models in unison-common
- [ ] Create schema generation script
- [ ] Generate schemas for:
  - EventEnvelope
  - Auth models (Token, User, etc.)
  - Consent models
  - Monitoring models
  - Performance models
- [ ] Validate generated schemas
- [ ] Store schemas in `schemas/` directory

**Deliverables**:
- JSON schemas for all models
- Schema generation script
- Schema documentation

---

### Phase 2: Contract Test Suite

**Goal**: Create tests that validate message schemas

**Tasks**:
- [ ] Create contract test framework
- [ ] Write tests for EventEnvelope
- [ ] Write tests for Auth messages
- [ ] Write tests for Consent messages
- [ ] Write tests for cross-service messages
- [ ] Add schema validation tests
- [ ] Test backward compatibility

**Deliverables**:
- Contract test suite (20+ tests)
- Test documentation
- CI/CD integration

---

### Phase 3: Package Preparation

**Goal**: Prepare unison-common for distribution

**Tasks**:
- [ ] Update version to 0.1.0
- [ ] Verify pyproject.toml configuration
- [ ] Build package: `python -m build`
- [ ] Test package installation
- [ ] Verify all imports work
- [ ] Test with sample service

**Deliverables**:
- Built package (wheel + sdist)
- Installation verification
- Import tests

---

### Phase 4: Distribution Setup

**Goal**: Set up package distribution

**Options**:

#### Option A: Local File Distribution (Simplest)
```bash
# Build package
cd unison-common
python -m build

# Install in services
pip install /path/to/unison-common/dist/unison_common-0.1.0-py3-none-any.whl
```

#### Option B: Private PyPI (Recommended)
```bash
# Using devpi (local PyPI server)
pip install devpi-server devpi-client
devpi-server --start
devpi use http://localhost:3141
devpi login root --password=''
devpi index -c dev
devpi use root/dev
devpi upload
```

#### Option C: GitHub Packages
```bash
# Using GitHub as package registry
pip install twine
twine upload --repository-url https://upload.pypi.org/legacy/ dist/*
```

**Decision**: Start with Option A (local), prepare for Option B

---

### Phase 5: Service Updates

**Goal**: Update all services to use packaged version

**Tasks**:
- [ ] Update requirements.txt in all services
- [ ] Remove `-e ../unison-common`
- [ ] Add `unison-common==0.1.0`
- [ ] Test each service individually
- [ ] Update docker-compose.yml if needed
- [ ] Update Dockerfiles

**Services to Update** (14):
- [ ] unison-orchestrator
- [ ] unison-storage
- [ ] unison-policy
- [ ] unison-auth
- [ ] unison-consent
- [ ] unison-context
- [ ] unison-inference
- [ ] unison-intent-graph
- [ ] unison-context-graph
- [ ] unison-experience-renderer
- [ ] unison-agent-vdi
- [ ] unison-io-core
- [ ] unison-io-speech
- [ ] unison-io-vision

---

### Phase 6: CI/CD Integration

**Goal**: Automate contract testing

**Tasks**:
- [ ] Create GitHub Actions workflow
- [ ] Add contract test job
- [ ] Run on PR and merge
- [ ] Add badge to README
- [ ] Set up notifications

**Workflow**:
```yaml
name: Contract Tests
on: [push, pull_request]
jobs:
  contract-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-python@v4
      - run: pip install -e .
      - run: pytest tests/contract/
```

---

## üìê Technical Design

### Schema Generation Script

**Script**: `generate_all_schemas.py`

```python
from pydantic import BaseModel
from unison_common.envelope import EventEnvelope
from unison_common.auth import Token, User
# ... import all models

def generate_schema(model: type[BaseModel], output_path: str):
    schema = model.model_json_schema()
    with open(output_path, 'w') as f:
        json.dump(schema, f, indent=2)

# Generate all schemas
generate_schema(EventEnvelope, "schemas/event-envelope.json")
generate_schema(Token, "schemas/auth-token.json")
# ... etc
```

### Contract Tests Checklist

**Structure**:
```
tests/contract/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ test_event_envelope.py
‚îú‚îÄ‚îÄ test_auth_messages.py
‚îú‚îÄ‚îÄ test_consent_messages.py
‚îú‚îÄ‚îÄ test_monitoring_messages.py
‚îî‚îÄ‚îÄ test_schema_validation.py
```

**Example Test**:
```python
import json
import jsonschema
from unison_common.envelope import EventEnvelope

def test_event_envelope_schema():
    # Load schema
    with open("schemas/event-envelope.json") as f:
        schema = json.load(f)
    
    # Create valid message
    envelope = EventEnvelope(
        event_id="test-123",
        event_type="test.event",
        timestamp=1234567890,
        payload={"key": "value"}
    )
    
    # Validate against schema
    jsonschema.validate(envelope.model_dump(), schema)
```

---

## ‚úÖ Acceptance Criteria

### Package Distribution
- [ ] unison-common builds successfully
- [ ] Package installs without errors
- [ ] All imports work correctly
- [ ] No editable installs remain

### Schema Generation Checklist
- [ ] All Pydantic models have schemas
- [ ] Schemas are valid JSON Schema format
- [ ] Schemas include descriptions
- [ ] Schemas are versioned

### Contract Tests
- [ ] 20+ contract tests written
- [ ] All tests pass
- [ ] Tests validate schemas
- [ ] Tests check backward compatibility
- [ ] CI/CD runs tests automatically

### Service Updates
- [ ] All 14 services updated
- [ ] All services use `unison-common==0.1.0`
- [ ] No `-e ../unison-common` in requirements
- [ ] All services build successfully
- [ ] All services pass tests

---

## üìä Success Metrics

| Metric | Target | Current |
|--------|--------|---------|
| **Services using package** | 14/14 | 0/14 |
| **Schemas generated** | 10+ | 1 |
| **Contract tests** | 20+ | 0 |
| **CI/CD integration** | Yes | No |
| **Package build success** | 100% | TBD |
| **Test pass rate** | 100% | TBD |

---

## üöÄ Rollout Plan

### Week 1: Schema & Tests (Days 1-2)
- Day 1: Generate all schemas, create contract test framework
- Day 2: Write contract tests, validate schemas

### Week 2: Package & Distribution (Days 3-4)
- Day 3: Build package, set up distribution
- Day 4: Update services, test integration

### Week 3: CI/CD & Documentation (Day 5)
- Day 5: Add CI/CD, update docs, final testing

---

## üîí Risk Mitigation

### Risk: Breaking Changes
**Mitigation**: Contract tests catch breaking changes before deployment

### Risk: Version Conflicts
**Mitigation**: Pin exact version (0.1.0), use semantic versioning

### Risk: Distribution Issues
**Mitigation**: Start with local distribution, test thoroughly

### Risk: Service Failures
**Mitigation**: Update services one at a time, test each

---

## üìö Documentation

### Files to Create/Update

1. **unison-common/CHANGELOG.md** - Version history
2. **unison-common/SCHEMAS.md** - Schema documentation
3. **unison-common/CONTRACT_TESTS.md** - Test guide
4. **unison-common/DISTRIBUTION.md** - Distribution guide
5. **README.md** - Update with package usage

---

## üéØ Next Steps

1. ‚úÖ Create implementation plan (this document)
2. ‚è≥ Generate JSON schemas from Pydantic models
3. ‚è≥ Create contract test suite
4. ‚è≥ Build and test package
5. ‚è≥ Set up distribution
6. ‚è≥ Update services
7. ‚è≥ Add CI/CD integration

---

**Status**: Ready to implement  
**Estimated Time**: 3-4 days  
**Priority**: High (blocks other P2 tasks)
